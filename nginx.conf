events {
    worker_connections 1024;
}

http {
    upstream frontend {
        server frontend:3000;
    }

    server {
        listen 80;
        
        # Hide nginx version
        server_tokens off;
        
        # Security headers
        add_header X-Frame-Options "DENY" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
        
        # Cross-Origin headers (Spectre protection)
        add_header Cross-Origin-Opener-Policy "same-origin" always;
        add_header Cross-Origin-Resource-Policy "same-site" always;
        
        # CSP - allow Vite dev server and external resources
        add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://unpkg.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com data:; img-src 'self' data: https:; connect-src 'self' https://unpkg.com https://cdn.jsdelivr.net; frame-ancestors 'none';" always;

        # Block common scanner paths (return 404 for bot filtering)
        location ~* \.(php|asp|aspx|jsp|cgi|pl|sh|py|rb)$ {
            return 404;
        }
        
        # Block admin/backdoor paths
        location ~* ^/(admin|wp-admin|wp-login|administrator|phpmyadmin|mysql|sql|backup|config|\.env|\.git) {
            return 404;
        }
        
        # Common proxy headers (reusable)
        proxy_set_header Host $http_host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Allow Vite dev server paths (must come before blocking rules)
        location ~ ^/(@vite|node_modules|src)/ {
            proxy_pass http://frontend;
        }

        # Data directory - proxy to frontend
        location /data/ {
            proxy_pass http://frontend;
        }

        # Block paths with multiple segments that aren't allowed above
        # This catches things like /admin/login, /wp-admin/install, etc.
        location ~ ^/[^/]+/[^/]+/ {
            return 404;
        }

        # Frontend - proxy to Vite dev server
        location / {
            proxy_pass http://frontend;
            proxy_set_header X-Forwarded-Host $host;
        }
    }
}
